<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸ìŠ¤íƒ€ ë§íŒ” íŒë…ê¸° (ìµœì¢…)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d);
            --bg-color: #fafafa;
            --text-dark: #262626;
            --text-gray: #8e8e8e;
            --border-color: #dbdbdb;
            --success-color: #0095f6;
            --danger-color: #ed4956;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-dark);
            display: flex;
            justify-content: center;
            padding: 20px 10px;
            min-height: 100vh;
        }

        .container {
            background: white;
            width: 100%;
            max-width: 480px;
            padding: 30px 25px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }

        header { text-align: center; margin-bottom: 25px; }
        h2 { font-size: 22px; margin-bottom: 8px; font-weight: 800; }
        .safety-badge {
            display: inline-block;
            background: #e8f5e9; color: #2e7d32;
            font-size: 12px; font-weight: bold;
            padding: 4px 10px; border-radius: 20px;
            margin-bottom: 10px;
        }
        .desc { color: var(--text-gray); font-size: 13px; line-height: 1.5; }

        /* ê°€ì´ë“œ (ì•„ì½”ë””ì–¸) */
        details {
            background: #f8f9fa; border-radius: 12px; padding: 12px; margin-bottom: 20px; 
            border: 1px solid var(--border-color); cursor: pointer; transition: 0.2s;
        }
        details[open] { background: #fff; border-color: #c13584; }
        summary { font-weight: bold; color: #0095f6; outline: none; font-size: 14px; }
        .guide-steps { margin-top: 15px; font-size: 13px; color: var(--text-dark); padding-left: 20px; line-height: 1.6;}
        .highlight { color: #c13584; font-weight: bold; }

        /* íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ */
        .upload-group { margin-bottom: 15px; }
        .custom-file-upload {
            display: flex; align-items: center; justify-content: flex-start;
            width: 100%; padding: 15px;
            border: 2px dashed var(--border-color); border-radius: 12px;
            cursor: pointer; transition: all 0.3s; background: white; color: var(--text-gray); font-weight: 500; font-size: 14px;
        }
        .custom-file-upload:hover { border-color: #c13584; background: #fffcfd; color: #c13584; }
        .custom-file-upload.uploaded { border-style: solid; border-color: var(--success-color); color: var(--success-color); background: #e3f2fd; }
        .upload-icon { margin-right: 10px; font-size: 18px; }
        .file-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 220px; }
        input[type="file"] { display: none; }

        /* ë¶„ì„ ë²„íŠ¼ */
        .analyze-btn {
            width: 100%; padding: 16px;
            background: var(--primary-gradient);
            color: white; border: none; border-radius: 12px;
            font-size: 16px; font-weight: bold;
            cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(193, 53, 132, 0.3);
            margin-top: 10px;
        }
        .analyze-btn:active { transform: scale(0.98); }
        .analyze-btn:disabled { opacity: 0.7; cursor: wait; }

        /* ê²°ê³¼ ì˜ì—­ */
        #result { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; display: none; }
        
        .summary-box { text-align: center; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 15px; border: 1px solid #eee; }
        .stat-row { display: flex; justify-content: space-around; margin-bottom: 15px; font-size: 14px; }
        .stat-item strong { display: block; font-size: 18px; margin-top: 5px; color: #262626; }
        
        .result-title { font-size: 18px; font-weight: 800; color: var(--danger-color); margin-bottom: 15px; text-align: center; }
        
        /* ê²€ìƒ‰ì°½ ë° ë„êµ¬ */
        .tools { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-input { flex: 1; padding: 10px; border: 1px solid #dbdbdb; border-radius: 8px; font-size: 14px; }
        .copy-btn { padding: 10px 15px; background: #262626; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .user-list { max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; }
        .user-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; border-bottom: 1px solid #f0f0f0; background: white;
        }
        .user-item:last-child { border-bottom: none; }
        .user-info { display: flex; align-items: center; }
        .user-avatar {
            width: 36px; height: 36px; background-color: #eee; border-radius: 50%; margin-right: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 18px;
        }
        .user-name { font-weight: 600; font-size: 14px; color: #262626; }
        
        .action-btn { 
            text-decoration: none; color: white; background-color: var(--success-color); 
            font-size: 12px; font-weight: bold; padding: 6px 12px; border-radius: 6px; 
        }
        .action-btn:hover { background-color: #0077c5; }

        .ghost-alert { font-size: 12px; color: #e1306c; margin-top: 10px; background: #fff0f3; padding: 10px; border-radius: 8px; text-align: left;}
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="safety-badge">ğŸ”’ 100% ë¡œì»¬ ì‹¤í–‰ (í•´í‚¹ ìœ„í—˜ ì—†ìŒ)</div>
        <h2>ğŸ•µï¸â€â™€ï¸ ì¸ìŠ¤íƒ€ ë§íŒ” íŒë…ê¸°</h2>
        <p class="desc">
            ZIP íŒŒì¼ ê·¸ëŒ€ë¡œ ì˜¬ë ¤ë„ OK!<br>
            ëŒ€ìš©ëŸ‰ íŒŒì¼ ìë™ ì²˜ë¦¬ ì§€ì›
        </p>
    </header>

    <details>
        <summary>ğŸ“‚ ë°ì´í„° ë‹¤ìš´ë¡œë“œ ë°©ë²• (í•„ë…)</summary>
        <ol class="guide-steps">
            <li>ì¸ìŠ¤íƒ€ ì„¤ì • â†’ <strong>ë‚´ í™œë™</strong> â†’ ë‚´ ì •ë³´ ë‹¤ìš´ë¡œë“œ</li>
            <li>ê¸°ê¸°ë¡œ ë‹¤ìš´ë¡œë“œ â†’ <strong>'íŒ”ë¡œì›Œ ë° íŒ”ë¡œì‰'</strong>ë§Œ ì²´í¬</li>
            <li>ê¸°ê°„: <span class="highlight">ì „ì²´ ê¸°ê°„</span> (í•„ìˆ˜!)</li>
            <li>í˜•ì‹: <span class="highlight">JSON</span> (í•„ìˆ˜!)</li>
            <li>ë©”ì¼ë¡œ ì˜¨ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (ZIP íŒŒì¼ ì••ì¶• í’€ í•„ìš” X)</li>
        </ol>
    </details>

    <div class="upload-group">
        <label for="followingFile" class="custom-file-upload" id="label-following">
            <span class="upload-icon">ğŸ“¤</span>
            <span class="file-name" id="text-following">1. ë‚´ê°€ íŒ”ë¡œìš°í•˜ëŠ” íŒŒì¼ (JSON/ZIP)</span>
        </label>
        <input type="file" id="followingFile" accept=".json, .zip">
    </div>

    <div class="upload-group">
        <label for="followersFile" class="custom-file-upload" id="label-followers">
            <span class="upload-icon">ğŸ“¥</span>
            <span class="file-name" id="text-followers">2. ë‚˜ë¥¼ íŒ”ë¡œìš°í•˜ëŠ” íŒŒì¼ (JSON/ZIP)</span>
        </label>
        <input type="file" id="followersFile" accept=".json, .zip">
    </div>

    <button class="analyze-btn" onclick="analyzeFiles()">ğŸ” ë¶„ì„ ì‹œì‘í•˜ê¸°</button>

    <div id="result">
        <div class="summary-box" id="summaryBox"></div>
        
        <div class="result-title" id="resultTitle"></div>
        
        <div class="tools">
            <input type="text" id="searchInput" class="search-input" placeholder="ì•„ì´ë”” ê²€ìƒ‰..." onkeyup="filterList()">
            <button class="copy-btn" onclick="copyList()">ğŸ“‹ ëª©ë¡ ë³µì‚¬</button>
        </div>

        <div class="user-list" id="userList"></div>
    </div>
</div>

<script>
    // ì „ì—­ ë³€ìˆ˜ë¡œ ë¦¬ìŠ¤íŠ¸ ì €ì¥ (ê²€ìƒ‰ ê¸°ëŠ¥ì„ ìœ„í•´)
    let globalUnfollowerList = [];

    // íŒŒì¼ ì„ íƒ ì‹œ UI ë³€ê²½
    document.getElementById('followingFile').addEventListener('change', function(e) {
        updateLabel('label-following', 'text-following', e.target.files[0], 'following');
    });
    document.getElementById('followersFile').addEventListener('change', function(e) {
        updateLabel('label-followers', 'text-followers', e.target.files[0], 'followers');
    });

    function updateLabel(labelId, textId, file, type) {
        const label = document.getElementById(labelId);
        const text = document.getElementById(textId);
        if (file) {
            label.classList.add('uploaded');
            text.innerText = `âœ… ì„ íƒë¨: ${file.name}`;
        } else {
            label.classList.remove('uploaded');
            text.innerText = type === 'following' 
                ? '1. ë‚´ê°€ íŒ”ë¡œìš°í•˜ëŠ” íŒŒì¼ (JSON/ZIP)' 
                : '2. ë‚˜ë¥¼ íŒ”ë¡œìš°í•˜ëŠ” íŒŒì¼ (JSON/ZIP)';
        }
    }

    // â˜… ë¶„ì„ ë¡œì§ ì‹œì‘ â˜…
    async function analyzeFiles() {
        const followingInput = document.getElementById('followingFile');
        const followersInput = document.getElementById('followersFile');
        const btn = document.querySelector('.analyze-btn');

        if (!followingInput.files[0] || !followersInput.files[0]) {
            alert("íŒŒì¼ ë‘ ê°œë¥¼ ëª¨ë‘ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”! ğŸ˜¥\n(ê°™ì€ ZIP íŒŒì¼ì„ ìœ„ì•„ë˜ë¡œ ë‘ ë²ˆ ë„£ìœ¼ì…”ë„ ë©ë‹ˆë‹¤)");
            return;
        }

        // ë¡œë”© ìƒíƒœ
        btn.innerHTML = 'ë°ì´í„° ë¶„ì„ ì¤‘... â³';
        btn.disabled = true;
        document.getElementById('result').style.display = 'none';

        try {
            // íŒŒì¼ ì½ê¸° (ë¹„ë™ê¸° ë³‘ë ¬ ì²˜ë¦¬)
            const [followingData, followersData] = await Promise.all([
                readFileOrZip(followingInput.files[0], 'following'),
                readFileOrZip(followersInput.files[0], 'followers')
            ]);

            // ë°ì´í„° ë³‘í•© ë° ì¶”ì¶œ
            const followingList = processData(followingData);
            const followersList = processData(followersData);

            console.log(`íŒ”ë¡œì‰: ${followingList.length}, íŒ”ë¡œì›Œ: ${followersList.length}`);

            // ìœ íš¨ì„± ê²€ì‚¬
            if (followingList.length === 0) throw new Error("íŒ”ë¡œì‰ ëª©ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            if (followersList.length === 0) throw new Error("íŒ”ë¡œì›Œ ëª©ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            // â˜… í•µì‹¬ ë¹„êµ ë¡œì§ â˜…
            const followersSet = new Set(followersList);
            globalUnfollowerList = followingList.filter(user => !followersSet.has(user));

            // ê²°ê³¼ í™”ë©´ ì¶œë ¥
            displayResult(globalUnfollowerList, followingList.length, followersList.length);
            
            // ê²°ê³¼ì°½ í‘œì‹œ
            document.getElementById('result').style.display = 'block';
            
            // ìŠ¤í¬ë¡¤ ì´ë™
            setTimeout(() => {
                document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
            }, 100);

        } catch (error) {
            console.error(error);
            alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
        } finally {
            btn.innerHTML = 'ğŸ” ë¶„ì„ ì‹œì‘í•˜ê¸°';
            btn.disabled = false;
        }
    }

    // JSON ë¬¸ìì—´ ë°°ì—´ì„ ë°›ì•„ì„œ ìœ ì € ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
    function processData(jsonStringArray) {
        let allUsers = [];
        jsonStringArray.forEach(jsonText => {
            try {
                const json = JSON.parse(jsonText);
                const extracted = extractUsers(json);
                allUsers = [...allUsers, ...extracted];
            } catch (e) {
                console.warn("JSON íŒŒì‹± ê±´ë„ˆëœ€", e);
            }
        });
        return [...new Set(allUsers)]; // ì¤‘ë³µ ì œê±°
    }

    // íŒŒì¼ ë˜ëŠ” ZIP ì½ê¸°
    async function readFileOrZip(file, type) {
        // 1. ë‹¨ì¼ JSON íŒŒì¼ì¸ ê²½ìš°
        if (file.name.toLowerCase().endsWith('.json')) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve([e.target.result]);
                reader.onerror = (e) => reject(new Error("íŒŒì¼ ì½ê¸° ì‹¤íŒ¨"));
                reader.readAsText(file);
            });
        }
        
        // 2. ZIP íŒŒì¼ì¸ ê²½ìš°
        if (file.name.toLowerCase().endsWith('.zip')) {
            try {
                const zip = await JSZip.loadAsync(file);
                let targetFiles = [];
                let isHtmlDetected = false;

                // ZIP ë‚´ë¶€ ê²€ìƒ‰ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´)
                const regex = type === 'following' ? /following/i : /followers/i;

                for (const [relativePath, zipEntry] of Object.entries(zip.files)) {
                    if (zipEntry.name.toLowerCase().endsWith('.html')) isHtmlDetected = true;

                    // í´ë” ì•ˆì— ìˆë“  ë°–ì— ìˆë“  ì´ë¦„ì— following/followersê°€ í¬í•¨ëœ JSON ì°¾ê¸°
                    if (regex.test(zipEntry.name) && zipEntry.name.toLowerCase().endsWith('.json')) {
                        const content = await zipEntry.async("string");
                        targetFiles.push(content);
                    }
                }

                if (targetFiles.length > 0) return targetFiles;
                
                if (isHtmlDetected) throw new Error("HTML í˜•ì‹ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤! ì¸ìŠ¤íƒ€ì—ì„œ 'JSON' í˜•ì‹ìœ¼ë¡œ ë‹¤ì‹œ ë°›ì•„ì£¼ì„¸ìš”.");
                throw new Error("ZIP íŒŒì¼ ì•ˆì—ì„œ ê´€ë ¨ JSON íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

            } catch (err) {
                throw err;
            }
        }

        throw new Error("ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (JSON ë˜ëŠ” ZIPë§Œ ê°€ëŠ¥)");
    }

    // ì¸ìŠ¤íƒ€ ë°ì´í„° êµ¬ì¡°ì—ì„œ ì•„ì´ë”” ì¶”ì¶œ (ë‹¤ì–‘í•œ í¬ë§· ëŒ€ì‘)
    function extractUsers(json) {
        let rawDataList = [];

        // ë°ì´í„° êµ¬ì¡° ì •ê·œí™”
        if (Array.isArray(json)) {
            rawDataList = json;
        } else if (typeof json === 'object') {
            // ê°ì²´ì¸ ê²½ìš° ë°°ì—´ì„ í¬í•¨í•œ í‚¤ë¥¼ ì°¾ìŒ (relationships_following ë“±)
            for (let key in json) {
                if (Array.isArray(json[key])) {
                    rawDataList = json[key];
                    break;
                }
            }
        }

        const userSet = new Set();
        rawDataList.forEach(item => {
            let username = null;
            // 1. ìµœì‹  ë°ì´í„° êµ¬ì¡° (string_list_data)
            if (item.string_list_data && item.string_list_data[0]) {
                username = item.string_list_data[0].value;
            } 
            // 2. êµ¬ë²„ì „ ë°ì´í„° êµ¬ì¡° (value)
            else if (item.title) {
                username = item.title;
            }
            // 3. ì•„ì£¼ ì˜›ë‚  ë²„ì „
            else if (item.value) {
                username = item.value;
            }

            if (username) userSet.add(username);
        });

        return Array.from(userSet);
    }

    function displayResult(list, followingCount, followersCount) {
        const summaryBox = document.getElementById('summaryBox');
        const userListDiv = document.getElementById('userList');
        const resultTitle = document.getElementById('resultTitle');

        // í†µê³„ í‘œì‹œ
        summaryBox.innerHTML = `
            <div class="stat-row">
                <div class="stat-item">
                    <span>ë‚´ê°€ íŒ”ë¡œìš°</span>
                    <strong style="color:#0095f6">${followingCount}</strong>
                </div>
                <div class="stat-item">
                    <span>ë‚˜ë¥¼ íŒ”ë¡œìš°</span>
                    <strong style="color:#262626">${followersCount}</strong>
                </div>
                <div class="stat-item">
                    <span>ë§íŒ” ì•„ë‹˜</span>
                    <strong style="color:#ed4956">${list.length}</strong>
                </div>
            </div>
            ${followersCount < 10 && followingCount > 100 ? 
                `<div class="ghost-alert">âš ï¸ <strong>ì£¼ì˜:</strong> íŒ”ë¡œì›Œê°€ ë„ˆë¬´ ì ê²Œ ë‚˜ì™”ìŠµë‹ˆë‹¤.<br>ë‹¤ìš´ë¡œë“œ ì‹œ ê¸°ê°„ì„ 'ì „ì²´ ê¸°ê°„'ìœ¼ë¡œ ì„¤ì •í•˜ì§€ ì•Šì•˜ì„ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.</div>` : ''}
        `;

        resultTitle.innerText = `ğŸ˜¡ ë‚˜ë¥¼ ì•ˆ ë³´ëŠ” ì‚¬ëŒ (${list.length}ëª…)`;

        // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        renderList(list);
    }

    // ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ê²€ìƒ‰ í•„í„°ë§ì„ ìœ„í•´ ë¶„ë¦¬)
    function renderList(list) {
        const userListDiv = document.getElementById('userList');
        
        if (list.length === 0) {
            userListDiv.innerHTML = `
                <div style="text-align:center; padding: 40px;">
                    <div style="font-size: 40px;">ğŸ‰</div>
                    <p style="margin-top:10px; font-weight:bold;">ëª¨ë‘ê°€ ë‹¹ì‹ ì„ ë§íŒ” ì¤‘ì…ë‹ˆë‹¤!</p>
                </div>`;
            return;
        }

        let html = '';
        list.forEach(user => {
            html += `
            <div class="user-item">
                <div class="user-info">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <span class="user-name">${user}</span>
                </div>
                <a href="https://instagram.com/${user}" target="_blank" class="action-btn">í”„ë¡œí•„ ></a>
            </div>`;
        });
        userListDiv.innerHTML = html;
    }

    // ê²€ìƒ‰ ê¸°ëŠ¥
    function filterList() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const filtered = globalUnfollowerList.filter(user => user.toLowerCase().includes(query));
        renderList(filtered);
    }

    // ë³µì‚¬ ê¸°ëŠ¥
    function copyList() {
        if (globalUnfollowerList.length === 0) {
            alert("ë³µì‚¬í•  ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        const text = globalUnfollowerList.join('\n');
        navigator.clipboard.writeText(text).then(() => {
            alert(`ì´ ${globalUnfollowerList.length}ëª…ì˜ ëª…ë‹¨ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }).catch(() => {
            alert("ë³µì‚¬ ì‹¤íŒ¨ (ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸ í•„ìš”)");
        });
    }
</script>

</body>
</html>
